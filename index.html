<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Formulário Controle de Desconto RJ x ES</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- SDK Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
@font-face {
    font-family: 'Aptos Display';
    src: local('Aptos Display'), local('AptosDisplay');
}

body {
    font-family: 'Segoe UI', Arial, sans-serif;
    background: #F5F7FA;
    margin: 0;
    padding: 0;
}

/* ====================== ESTILOS ========================== */

.header {
    width: 100%;
    padding: 40px 20px;
    background: #0A3D62;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    position: relative;
    box-shadow: 0 2px 8px rgba(0,0,0,0.25);
}

.header img {
    height: 105px;
    position: absolute;
    left: 25px;
    top: 50%;
    transform: translateY(-50%);
}

.header-title {
    font-family: 'Aptos Display';
    font-size: 34px;
    font-weight: 900;
    letter-spacing: 2px;
    text-transform: uppercase;
}

.container {
    max-width: 960px;
    background: #FFFFFF;
    margin: 40px auto;
    padding: 35px;
    border-radius: 14px;
    box-shadow: 0 4px 18px rgba(0,0,0,0.1);
}

.section-title {
    font-size: 20px;
    margin-top: 25px;
    margin-bottom: 10px;
    font-weight: bold;
    color: #0A3D62;
    border-left: 5px solid #1B7FC2;
    padding-left: 10px;
}

label {
    display: block;
    margin: 10px 0 6px;
    font-weight: 600;
    color: #0A3D62;
}

input, select, textarea {
    width: 100%;
    padding: 13px;
    font-size: 15px;
    border-radius: 8px;
    border: 1px solid #C5D9E8;
    background: #F9FCFF;
    box-sizing: border-box;
}

textarea {
    min-height: 90px;
}

/* TABELA */
.materials-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    margin-top: 15px;
}

.materials-table th {
    background: #0A3D62;
    color: white;
    padding: 12px;
    text-align: left;
}

.materials-table td {
    border: 1px solid #ddd;
    padding: 10px;
    vertical-align: middle;
}

.materials-table input {
    width: 100%;
    box-sizing: border-box;
    padding: 8px;
}

.remove-line-btn {
    background: #D9534F;
    color: white;
    border: none;
    padding: 8px 12px;
    cursor: pointer;
    border-radius: 5px;
}

.btn-add {
    margin-top: 20px;
    background: #1B7FC2;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    cursor: pointer;
}

.total-box {
    background: #D8ECFF;
    padding: 18px;
    border-radius: 10px;
    font-size: 22px;
    font-weight: bold;
    margin-top: 25px;
    text-align: right;
}

.submit-btn {
    margin-top: 35px;
    width: 100%;
    padding: 17px;
    background: #0A3D62;
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 20px;
    font-weight: bold;
    cursor: pointer;
}

.success-box {
    margin-top: 25px;
    display: none;
    background: #D4EDDA;
    color: #155724;
    border: 1px solid #A3D4A5;
    padding: 18px;
    border-radius: 10px;
    font-size: 18px;
    font-weight: bold;
    text-align: center;
}

.error-box {
    margin-top: 15px;
    display: none;
    background: #F8D7DA;
    color: #721c24;
    border: 1px solid #F5C6CB;
    padding: 12px;
    border-radius: 8px;
}
</style>
</head>

<body>

<div class="header">
    <img src="logohallen.png" alt="Logo Hallen">
    <div class="header-title">Formulário Controle de Desconto RJ x ES</div>
</div>

<div class="container">
    <div id="successBox" class="success-box">✔ Formulário enviado com sucesso!</div>
    <div id="errorBox" class="error-box"></div>

    <form id="formulario" onsubmit="return false;">

        <div class="section-title">Dados do Técnico</div>

        <label>Nome do Técnico *</label>
        <input type="text" id="tec_nome">

        <label>UF *</label>
        <select id="uf">
            <option value="">Selecione...</option>
            <option value="RJ">RJ</option>
            <option value="ES">ES</option>
        </select>

        <label>Data do Desconto *</label>
        <input type="date" id="data_desc">

        <label>Descontado pela Vivo? *</label>
        <select id="vivo">
            <option value="">Selecione...</option>
            <option value="sim">Sim</option>
            <option value="não">Não</option>
        </select>

        <label>Desconto RH? *</label>
        <select id="rh">
            <option value="">Selecione...</option>
            <option value="sim">Sim</option>
            <option value="não">Não</option>
        </select>

        <label>Motivo do Desconto *</label>
        <select id="motivoSelect">
            <option value="">Selecione...</option>
            <option value="nada consta">Nada Consta</option>
            <option value="perda">Perda</option>
            <option value="aging">Aging</option>
            <option value="reversa">Reversa</option>
            <option value="furto">Furto</option>
        </select>

        <div class="section-title">Materiais / Ferramental / Serializados</div>

        <table class="materials-table" id="materialsTable">
            <tr>
                <th>Descrição</th>
                <th>Qtd.</th>
                <th>Valor Unitário (R$)</th>
                <th>Subtotal</th>
                <th>Ação</th>
            </tr>
        </table>

        <button class="btn-add" type="button" id="btnAddMaterial">+ Adicionar Descrição</button>

        <div class="total-box">
            Valor Total: R$ <span id="totalValue">0.00</span>
        </div>

        <div class="section-title">Responsável e Evidências</div>

        <label>Responsável pelo Desconto</label>
        <input type="text" id="resp">

        <label>Justificativa</label>
        <textarea id="just"></textarea>

        <label>Carta de Desconto (PDF)</label>
        <input type="file" id="pdf" accept="application/pdf">

        <label>Comprovante de Recebimento (PDF)</label>
        <input type="file" id="comprovantes" accept="application/pdf" multiple>

        <button class="submit-btn" id="btnEnviar" type="button">Enviar Formulário</button>

    </form>
</div>

<script>

/* ======================================================
       CONFIG SUPABASE
====================================================== */

const SUPABASE_URL = "https://qdepfsguebkfemeuybwl.supabase.co";
const SUPABASE_KEY = "sb_publishable_8Xt8BY8UGD9rYy9A4CPTfQ_3dXwqiRL";

const cliente = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ======================================================
        FUNÇÕES
====================================================== */

document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("btnAddMaterial").addEventListener("click", addMaterialRow);
    document.getElementById("btnEnviar").addEventListener("click", enviarFormulario);
    addMaterialRow();
});

/* ======================================================
    ADICIONAR LINHA NA TABELA
====================================================== */

function addMaterialRow() {
    const tabela = document.getElementById("materialsTable");
    const row = tabela.insertRow();

    row.innerHTML = `
        <td><input type="text" class="desc" placeholder="Descrição"></td>
        <td><input type="number" class="qtd" min="1" value="0" oninput="calcularTotal()"></td>
        <td><input type="number" class="valor" value="0.00" step="0.01" oninput="calcularTotal()"></td>
        <td><span class="subtotal">0.00</span></td>
        <td><button type="button" class="remove-line-btn">Remover</button></td>
    `;

    row.querySelector(".remove-line-btn").addEventListener("click", () => {
        row.remove();
        calcularTotal();
    });
}

/* ======================================================
    CALCULAR TOTAL
====================================================== */

function calcularTotal() {
    let total = 0;

    document.querySelectorAll("#materialsTable tr").forEach((linha, i) => {
        if (i === 0) return;

        const qtd = parseFloat(linha.querySelector(".qtd").value) || 0;
        const valor = parseFloat(linha.querySelector(".valor").value) || 0;

        const subtotal = qtd * valor;
        linha.querySelector(".subtotal").innerText = subtotal.toFixed(2);

        total += subtotal;
    });

    document.getElementById("totalValue").innerText = total.toFixed(2);
}

/* ======================================================
    ENVIAR FORMULÁRIO
====================================================== */

async function enviarFormulario() {

    const success = document.getElementById("successBox");
    const error = document.getElementById("errorBox");

    success.style.display = "none";
    error.style.display = "none";

    const btn = document.getElementById("btnEnviar");
    btn.disabled = true;
    btn.innerText = "Enviando...";

    try {

        /* Campos obrigatórios */
        const tec_nome = document.getElementById("tec_nome").value.trim();
        const uf = document.getElementById("uf").value;
        const data_desc = document.getElementById("data_desc").value;
        const motivo = document.getElementById("motivoSelect").value;
        const vivo = document.getElementById("vivo").value;
        const rh = document.getElementById("rh").value;

        if (!tec_nome || !uf || !data_desc || !motivo || !vivo || !rh) {
            throw new Error("Preencha todos os campos obrigatórios!");
        }

        /* Materiais */
        const materiais = [];
        document.querySelectorAll("#materialsTable tr").forEach((linha, i) => {
            if (i === 0) return;

            const desc = linha.querySelector(".desc").value.trim();
            const qtd = parseFloat(linha.querySelector(".qtd").value) || 0;
            const valor = parseFloat(linha.querySelector(".valor").value) || 0;

            if (desc) {
                materiais.push({
                    descricao: desc,
                    quantidade: qtd,
                    valor_unitario: valor,
                    subtotal: qtd * valor
                });
            }
        });

        const valor_total = materiais.reduce((a, b) => a + b.subtotal, 0);
        const responsavel = document.getElementById("resp").value.trim();
        const justificativa = document.getElementById("just").value.trim();

        /* UPLOAD PDF CARTA */
        let pdf_url = null;
        const pdf = document.getElementById("pdf").files[0];

        if (pdf) {
            if (pdf.type !== "application/pdf") {
                throw new Error("A carta de desconto deve estar em PDF!");
            }

            const nome = `pdfs/${Date.now()}_${pdf.name}`;

            const { error: upErr } = await cliente.storage
                .from("descontos")
                .upload(nome, pdf);

            if (!upErr) {
                const { data } = cliente.storage.from("descontos").getPublicUrl(nome);
                pdf_url = data.publicUrl;
            }
        }

        /* UPLOAD COMPROVANTES (PDF Somente) */
        let comprovantes_urls = [];
        const arquivos = Array.from(document.getElementById("comprovantes").files);

        for (const arquivo of arquivos) {
            if (arquivo.type !== "application/pdf") {
                throw new Error("Todos os comprovantes devem estar em PDF!");
            }

            const nome = `comprovantes/${Date.now()}_${arquivo.name}`;

            const { error: uErr } = await cliente.storage
                .from("descontos")
                .upload(nome, arquivo);

            if (!uErr) {
                const { data } = cliente.storage.from("descontos").getPublicUrl(nome);
                comprovantes_urls.push(data.publicUrl);
            }
        }

        /* SALVAR NO BANCO */
        const payload = {
            tec_nome, uf, data_desc, motivo, vivo, rh,
            materiais, valor_total, responsavel, justificativa,
            pdf_url, comprovantes_urls,
            created_at: new Date().toISOString()
        };

        const { error: insertErr } = await cliente.from("descontos").insert(payload);

        if (insertErr) throw insertErr;

        /* SUCESSO */
        success.style.display = "block";
        window.scrollTo({ top: 0, behavior: 'smooth' });

        document.getElementById("formulario").reset();
        document.getElementById("materialsTable").innerHTML = `
            <tr>
                <th>Descrição</th>
                <th>Qtd.</th>
                <th>Valor Unitário (R$)</th>
                <th>Subtotal</th>
                <th>Ação</th>
            </tr>
        `;

        addMaterialRow();
        calcularTotal();

        setTimeout(() => success.style.display = "none", 3000);

    } catch (err) {
        error.style.display = "block";
        error.innerText = err.message;

    } finally {
        btn.disabled = false;
        btn.innerText = "Enviar Formulário";
    }
}

</script>

</body>
</html>











































